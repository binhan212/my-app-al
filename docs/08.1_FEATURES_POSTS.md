# 08.1. FEATURES - POSTS MANAGEMENT

> ‚è±Ô∏è **Th·ªùi gian ƒë·ªçc**: 60-90 ph√∫t  
> üéØ **M·ª•c ti√™u**: Hi·ªÉu 100% t√≠nh nƒÉng qu·∫£n l√Ω b√†i vi·∫øt (Posts Management)

---

## üìò M·ª§C L·ª§C

1. [T·ªïng quan Posts Management](#1-t·ªïng-quan-posts-management)
2. [Database Schema](#2-database-schema)
3. [API Routes](#3-api-routes)
4. [Admin UI Components](#4-admin-ui-components)
5. [Public UI Components](#5-public-ui-components)
6. [Form Validation](#6-form-validation)
7. [File Upload](#7-file-upload)
8. [Complete Workflow](#8-complete-workflow)

---

## 1. T·ªïng quan Posts Management

### 1.1. Ch·ª©c nƒÉng ch√≠nh

**Posts Management** l√† t√≠nh nƒÉng qu·∫£n l√Ω b√†i vi·∫øt tin t·ª©c v·ªõi ƒë·∫ßy ƒë·ªß CRUD operations:

```
‚úÖ Create   - T·∫°o b√†i vi·∫øt m·ªõi
‚úÖ Read     - Xem danh s√°ch v√† chi ti·∫øt b√†i vi·∫øt
‚úÖ Update   - Ch·ªânh s·ª≠a b√†i vi·∫øt
‚úÖ Delete   - X√≥a b√†i vi·∫øt
‚úÖ Upload   - Upload ·∫£nh cover
‚úÖ Status   - Qu·∫£n l√Ω tr·∫°ng th√°i (draft/published/archived)
‚úÖ Category - Ph√¢n lo·∫°i theo danh m·ª•c
```

### 1.2. C·∫•u tr√∫c Files

```
app/
  admin/posts/
    page.tsx                          # Trang qu·∫£n l√Ω b√†i vi·∫øt (Admin)
  tin-tuc/
    page.tsx                          # Danh s√°ch b√†i vi·∫øt (Public)
    [slug]/
      page.tsx                        # Chi ti·∫øt b√†i vi·∫øt (Public)
  api/posts/
    route.ts                          # GET (list), POST (create)
    [id]/
      route.ts                        # GET (detail), PUT (update), DELETE

components/
  admin/
    PostsTable.tsx                    # Table hi·ªÉn th·ªã danh s√°ch
    PostFormDialog.tsx                # Form t·∫°o/s·ª≠a b√†i vi·∫øt
  posts/
    PostCard.tsx                      # Card hi·ªÉn th·ªã b√†i vi·∫øt
    PostDetail.tsx                    # Chi ti·∫øt b√†i vi·∫øt
    RelatedPosts.tsx                  # B√†i vi·∫øt li√™n quan

lib/
  validations.ts                      # Zod schema cho Post
```

---

## 2. Database Schema

### 2.1. Post Model

```prisma
// prisma/schema.prisma
model Post {
  id           Int       @id @default(autoincrement())
  title        String    @db.VarChar(255)
  slug         String    @unique @db.VarChar(255)
  content      String    @db.LongText
  excerpt      String?   @db.Text
  cover_image  String?   @db.VarChar(255)
  
  // Relationships
  category_id  Int?
  category     Category? @relation(fields: [category_id], references: [id])
  
  author_id    Int
  author       User      @relation(fields: [author_id], references: [id])
  
  // Status & Metadata
  status       PostStatus @default(draft) // draft, published, archived
  views        Int       @default(0)
  
  // Timestamps
  published_at DateTime?
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  tags         PostTag[]

  @@index([slug])
  @@index([status])
  @@index([published_at])
  @@map("posts")
}
```

### 2.2. Relationships

```
Post ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ belongs to ‚Üí Category (category_id)
       ‚îú‚îÄ‚îÄ‚îÄ belongs to ‚Üí User (author_id)
       ‚îî‚îÄ‚îÄ‚îÄ has many ‚Üí PostTag (tags)
```

**Gi·∫£i th√≠ch**:
- M·ªói `Post` thu·ªôc v·ªÅ 1 `Category` (optional)
- M·ªói `Post` ƒë∆∞·ª£c t·∫°o b·ªüi 1 `User` (author)
- M·ªói `Post` c√≥ th·ªÉ c√≥ nhi·ªÅu `Tags` (qua b·∫£ng PostTag)

### 2.3. Key Fields

| Field | Type | M√¥ t·∫£ |
|-------|------|-------|
| `slug` | String | URL-friendly identifier (t·ª± ƒë·ªông t·ª´ title) |
| `excerpt` | String? | T√≥m t·∫Øt ng·∫Øn (hi·ªÉn th·ªã trong list) |
| `cover_image` | String? | URL ·∫£nh thumbnail |
| `status` | Enum | `draft`, `published`, `archived` |
| `views` | Int | S·ªë l∆∞·ª£t xem (t·ª± ƒë·ªông tƒÉng) |
| `published_at` | DateTime? | Ng√†y xu·∫•t b·∫£n (null n·∫øu draft) |

---

## 3. API Routes

### 3.1. GET /api/posts - List Posts

**File**: `app/api/posts/route.ts`

```typescript
export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url)
    const page = parseInt(searchParams.get('page') || '1')
    const limit = parseInt(searchParams.get('limit') || '20')
    const skip = (page - 1) * limit

    const [posts, total] = await Promise.all([
      db.post.findMany({
        include: {
          author: {
            select: { id: true, full_name: true, username: true }
          },
          category: {
            select: { id: true, name: true }
          }
        },
        orderBy: { created_at: 'desc' },
        skip,
        take: limit
      }),
      db.post.count()
    ])

    return NextResponse.json({
      success: true,
      data: {
        posts,
        pagination: {
          page,
          limit,
          total,
          totalPages: Math.ceil(total / limit)
        }
      }
    })
  } catch (error) {
    console.error('Get posts error:', error)
    return NextResponse.json(
      { success: false, message: 'L·ªói server' },
      { status: 500 }
    )
  }
}
```

**Query Parameters**:
- `page`: Trang hi·ªán t·∫°i (default: 1)
- `limit`: S·ªë b√†i vi·∫øt m·ªói trang (default: 20)

**Response Format**:
```json
{
  "success": true,
  "data": {
    "posts": [
      {
        "id": 1,
        "title": "B√†i vi·∫øt ƒë·∫ßu ti√™n",
        "slug": "bai-viet-dau-tien",
        "excerpt": "T√≥m t·∫Øt b√†i vi·∫øt...",
        "cover_image": "/uploads/posts/image.jpg",
        "status": "published",
        "views": 150,
        "created_at": "2024-01-15T10:30:00.000Z",
        "author": {
          "id": 1,
          "full_name": "Nguy·ªÖn VƒÉn A",
          "username": "admin"
        },
        "category": {
          "id": 2,
          "name": "Tin t·ª©c"
        }
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 45,
      "totalPages": 3
    }
  }
}
```

### 3.2. POST /api/posts - Create Post

**Authentication**: Required (NextAuth session)

```typescript
export async function POST(request: NextRequest) {
  try {
    // 1. Ki·ªÉm tra authentication
    const session = await auth()
    
    if (!session?.user) {
      return NextResponse.json(
        { success: false, message: 'Unauthorized' },
        { status: 401 }
      )
    }

    // 2. Validate request body
    const body = await request.json()
    const validatedData = postSchema.parse(body)

    // 3. Create post v·ªõi slug t·ª± ƒë·ªông
    const post = await db.post.create({
      data: {
        title: validatedData.title,
        content: validatedData.content,
        excerpt: validatedData.excerpt || null,
        cover_image: validatedData.cover_image || null,
        category_id: validatedData.category_id || null,
        status: validatedData.status,
        published_at: validatedData.status === 'published' ? new Date() : null,
        slug: createSlug(validatedData.title),  // T·ª± ƒë·ªông t·∫°o slug
        author_id: parseInt(session.user.id),
      }
    })

    return NextResponse.json({
      success: true,
      data: post,
      message: 'ƒê√£ t·∫°o b√†i vi·∫øt m·ªõi'
    }, { status: 201 })
  } catch (error) {
    console.error('Create post error:', error)
    return NextResponse.json(
      { success: false, message: 'L·ªói server' },
      { status: 500 }
    )
  }
}
```

**Request Body**:
```json
{
  "title": "Ti√™u ƒë·ªÅ b√†i vi·∫øt",
  "content": "N·ªôi dung ƒë·∫ßy ƒë·ªß c·ªßa b√†i vi·∫øt...",
  "excerpt": "T√≥m t·∫Øt ng·∫Øn g·ªçn",
  "cover_image": "/uploads/posts/image.jpg",
  "category_id": 2,
  "status": "published"
}
```

**Validation** (Zod Schema):
- `title`: B·∫Øt bu·ªôc, max 255 k√Ω t·ª±
- `content`: B·∫Øt bu·ªôc
- `excerpt`: Optional, max 500 k√Ω t·ª±
- `status`: Enum (`draft`, `published`, `archived`)

### 3.3. GET /api/posts/[id] - Get Single Post

**File**: `app/api/posts/[id]/route.ts`

```typescript
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params
    
    const post = await db.post.findUnique({
      where: { id: parseInt(id) },
      include: {
        author: {
          select: { id: true, full_name: true, username: true }
        },
        category: {
          select: { id: true, name: true }
        }
      }
    })

    if (!post) {
      return NextResponse.json(
        { success: false, message: 'Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt' },
        { status: 404 }
      )
    }

    // TƒÉng view count (kh√¥ng ƒë·ª£i)
    db.post.update({
      where: { id: parseInt(id) },
      data: { views: { increment: 1 } }
    }).catch(console.error)

    return NextResponse.json({
      success: true,
      data: post
    })
  } catch (error) {
    console.error('Get post error:', error)
    return NextResponse.json(
      { success: false, message: 'L·ªói server' },
      { status: 500 }
    )
  }
}
```

**Features**:
- ‚úÖ T·ª± ƒë·ªông tƒÉng view count
- ‚úÖ Include author v√† category information
- ‚úÖ 404 n·∫øu kh√¥ng t√¨m th·∫•y

### 3.4. PUT /api/posts/[id] - Update Post

```typescript
export async function PUT(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const session = await auth()
    if (!session?.user) {
      return NextResponse.json(
        { success: false, message: 'Unauthorized' },
        { status: 401 }
      )
    }

    const { id } = await params
    const body = await request.json()
    const validatedData = postSchema.parse(body)

    // Ki·ªÉm tra quy·ªÅn s·ªü h·ªØu (optional - c√≥ th·ªÉ check author_id)
    const existingPost = await db.post.findUnique({
      where: { id: parseInt(id) }
    })

    if (!existingPost) {
      return NextResponse.json(
        { success: false, message: 'Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt' },
        { status: 404 }
      )
    }

    // Update post
    const post = await db.post.update({
      where: { id: parseInt(id) },
      data: {
        title: validatedData.title,
        content: validatedData.content,
        excerpt: validatedData.excerpt || null,
        cover_image: validatedData.cover_image || null,
        category_id: validatedData.category_id || null,
        status: validatedData.status,
        slug: createSlug(validatedData.title),
        // Update published_at n·∫øu chuy·ªÉn t·ª´ draft ‚Üí published
        published_at: 
          validatedData.status === 'published' && existingPost.status !== 'published'
            ? new Date()
            : existingPost.published_at,
      }
    })

    return NextResponse.json({
      success: true,
      data: post,
      message: 'ƒê√£ c·∫≠p nh·∫≠t b√†i vi·∫øt'
    })
  } catch (error) {
    console.error('Update post error:', error)
    return NextResponse.json(
      { success: false, message: 'L·ªói server' },
      { status: 500 }
    )
  }
}
```

**Logic ƒë·∫∑c bi·ªát**:
- ‚úÖ T·ª± ƒë·ªông set `published_at` khi chuy·ªÉn t·ª´ draft ‚Üí published
- ‚úÖ Kh√¥ng ghi ƒë√® `published_at` n·∫øu ƒë√£ published tr∆∞·ªõc ƒë√≥
- ‚úÖ Regenerate slug t·ª´ title m·ªõi

### 3.5. DELETE /api/posts/[id] - Delete Post

```typescript
export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const session = await auth()
    if (!session?.user) {
      return NextResponse.json(
        { success: false, message: 'Unauthorized' },
        { status: 401 }
      )
    }

    const { id } = await params

    // X√≥a post
    await db.post.delete({
      where: { id: parseInt(id) }
    })

    return NextResponse.json({
      success: true,
      message: 'ƒê√£ x√≥a b√†i vi·∫øt'
    })
  } catch (error) {
    console.error('Delete post error:', error)
    return NextResponse.json(
      { success: false, message: 'L·ªói server' },
      { status: 500 }
    )
  }
}
```

**L∆∞u √Ω**:
- ‚ö†Ô∏è Hard delete (x√≥a vƒ©nh vi·ªÖn)
- ‚ö†Ô∏è ·∫¢nh cover_image kh√¥ng t·ª± ƒë·ªông x√≥a kh·ªèi server
- üí° C√≥ th·ªÉ th√™m soft delete b·∫±ng c√°ch set `status = 'archived'`

---

## 4. Admin UI Components

### 4.1. PostsTable Component

**File**: `components/admin/PostsTable.tsx`

**Ch·ª©c nƒÉng**:
- Hi·ªÉn th·ªã danh s√°ch b√†i vi·∫øt d·∫°ng table
- N√∫t "T·∫°o b√†i vi·∫øt m·ªõi"
- Actions: Edit, Delete
- Pagination
- Link preview ƒë·∫øn trang public

**Code Structure**:

```tsx
'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'
import { Badge } from '@/components/ui/badge'
import { PostFormDialog } from './PostFormDialog'
import { AlertDialog } from '@/components/ui/alert-dialog'

type PostWithRelations = Post & {
  author: Pick<User, 'id' | 'full_name' | 'username'>
  category: Pick<Category, 'id' | 'name'> | null
}

interface PostsTableProps {
  posts: PostWithRelations[]
  categories: Category[]
  currentPage: number
  totalPages: number
}

export function PostsTable({ posts, categories, currentPage, totalPages }: PostsTableProps) {
  const [isCreateOpen, setIsCreateOpen] = useState(false)
  const [editingPost, setEditingPost] = useState<Post | null>(null)
  const [deletingPost, setDeletingPost] = useState<Post | null>(null)

  const handleDelete = async () => {
    // DELETE API call
  }

  return (
    <div className="space-y-4">
      {/* Create Button */}
      <div className="flex justify-end">
        <Button onClick={() => setIsCreateOpen(true)}>
          <PlusIcon className="w-4 h-4 mr-2" />
          T·∫°o b√†i vi·∫øt m·ªõi
        </Button>
      </div>

      {/* Table */}
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Ti√™u ƒë·ªÅ</TableHead>
            <TableHead>Danh m·ª•c</TableHead>
            <TableHead>T√°c gi·∫£</TableHead>
            <TableHead>Tr·∫°ng th√°i</TableHead>
            <TableHead>L∆∞·ª£t xem</TableHead>
            <TableHead>Ng√†y t·∫°o</TableHead>
            <TableHead className="text-right">H√†nh ƒë·ªông</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {posts.map((post) => (
            <TableRow key={post.id}>
              <TableCell>
                <Link href={`/tin-tuc/${post.slug}`} target="_blank">
                  {post.title}
                </Link>
              </TableCell>
              <TableCell>{post.category?.name || '‚Äî'}</TableCell>
              <TableCell>{post.author.full_name}</TableCell>
              <TableCell>
                <Badge variant={post.status === 'published' ? 'default' : 'secondary'}>
                  {post.status === 'published' ? 'ƒê√£ xu·∫•t b·∫£n' : 'Nh√°p'}
                </Badge>
              </TableCell>
              <TableCell>{post.views}</TableCell>
              <TableCell>{formatDate(post.created_at)}</TableCell>
              <TableCell>
                <DropdownMenu>
                  <DropdownMenuItem onClick={() => setEditingPost(post)}>
                    Ch·ªânh s·ª≠a
                  </DropdownMenuItem>
                  <DropdownMenuItem onClick={() => setDeletingPost(post)}>
                    X√≥a
                  </DropdownMenuItem>
                </DropdownMenu>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>

      {/* Dialogs */}
      <PostFormDialog
        open={isCreateOpen}
        onOpenChange={setIsCreateOpen}
        categories={categories}
        onSuccess={() => window.location.reload()}
      />

      <PostFormDialog
        open={!!editingPost}
        post={editingPost}
        categories={categories}
        onSuccess={() => window.location.reload()}
      />

      <AlertDialog open={!!deletingPost}>
        {/* Delete confirmation */}
      </AlertDialog>
    </div>
  )
}
```

**Features**:
- ‚úÖ Responsive table
- ‚úÖ Status badges v·ªõi m√†u s·∫Øc
- ‚úÖ Link preview v·ªõi target="_blank"
- ‚úÖ Dropdown menu cho actions
- ‚úÖ Confirmation dialog khi x√≥a

### 4.2. PostFormDialog Component

**File**: `components/admin/PostFormDialog.tsx`

**Ch·ª©c nƒÉng**:
- Form t·∫°o/s·ª≠a b√†i vi·∫øt trong Dialog
- Upload ·∫£nh cover
- Select category
- Textarea cho content
- Validation v·ªõi Zod + React Hook Form

**Code Structure**:

```tsx
'use client'

import { useState, useEffect } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Textarea } from '@/components/ui/textarea'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'

const postFormSchema = z.object({
  title: z.string().min(1, 'Ti√™u ƒë·ªÅ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng').max(255),
  content: z.string().min(1, 'N·ªôi dung kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng'),
  excerpt: z.string().max(500).optional(),
  cover_image: z.string().optional(),
  category_id: z.string().nullable().optional(),
  status: z.enum(['draft', 'published', 'archived']),
})

type PostFormData = z.infer<typeof postFormSchema>

interface PostFormDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  post?: Post | null
  categories: Category[]
  onSuccess: () => void
}

export function PostFormDialog({ open, onOpenChange, post, categories, onSuccess }: PostFormDialogProps) {
  const isEdit = !!post
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [isUploading, setIsUploading] = useState(false)
  const [previewImage, setPreviewImage] = useState<string | null>(null)

  const { register, handleSubmit, formState: { errors }, reset, setValue } = useForm<PostFormData>({
    resolver: zodResolver(postFormSchema),
  })

  // Reset form khi dialog m·ªü/ƒë√≥ng
  useEffect(() => {
    if (open && post) {
      reset({
        title: post.title,
        content: post.content,
        excerpt: post.excerpt || '',
        cover_image: post.cover_image || '',
        category_id: post.category_id?.toString() || null,
        status: post.status,
      })
      setPreviewImage(post.cover_image || null)
    } else if (open && !post) {
      reset({
        title: '',
        content: '',
        excerpt: '',
        cover_image: '',
        category_id: null,
        status: 'draft',
      })
      setPreviewImage(null)
    }
  }, [open, post, reset])

  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    setIsUploading(true)
    try {
      const formData = new FormData()
      formData.append('file', file)
      formData.append('type', 'posts')

      const response = await fetch('/api/upload', {
        method: 'POST',
        body: formData,
      })

      const result = await response.json()
      setValue('cover_image', result.data.url)
      setPreviewImage(result.data.url)
    } finally {
      setIsUploading(false)
    }
  }

  const onSubmit = async (data: PostFormData) => {
    setIsSubmitting(true)
    try {
      const payload = {
        ...data,
        category_id: data.category_id ? parseInt(data.category_id) : null,
      }

      const url = isEdit ? `/api/posts/${post.id}` : '/api/posts'
      const method = isEdit ? 'PUT' : 'POST'

      await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      })

      onSuccess()
      onOpenChange(false)
    } finally {
      setIsSubmitting(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>
            {isEdit ? 'Ch·ªânh s·ª≠a b√†i vi·∫øt' : 'T·∫°o b√†i vi·∫øt m·ªõi'}
          </DialogTitle>
        </DialogHeader>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          {/* Title */}
          <div>
            <Label>Ti√™u ƒë·ªÅ</Label>
            <Input {...register('title')} placeholder="Nh·∫≠p ti√™u ƒë·ªÅ b√†i vi·∫øt..." />
            {errors.title && <p className="text-sm text-red-500">{errors.title.message}</p>}
          </div>

          {/* Content */}
          <div>
            <Label>N·ªôi dung</Label>
            <Textarea {...register('content')} rows={10} />
            {errors.content && <p className="text-sm text-red-500">{errors.content.message}</p>}
          </div>

          {/* Excerpt */}
          <div>
            <Label>T√≥m t·∫Øt (optional)</Label>
            <Textarea {...register('excerpt')} rows={3} />
          </div>

          {/* Cover Image Upload */}
          <div>
            <Label>·∫¢nh cover</Label>
            <Input type="file" accept="image/*" onChange={handleFileUpload} disabled={isUploading} />
            {previewImage && (
              <Image src={previewImage} alt="Preview" width={200} height={120} className="mt-2 rounded" />
            )}
          </div>

          {/* Category Select */}
          <div>
            <Label>Danh m·ª•c</Label>
            <Select onValueChange={(value) => setValue('category_id', value)}>
              <SelectTrigger>
                <SelectValue placeholder="Ch·ªçn danh m·ª•c..." />
              </SelectTrigger>
              <SelectContent>
                {categories.map((cat) => (
                  <SelectItem key={cat.id} value={cat.id.toString()}>
                    {cat.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          {/* Status Select */}
          <div>
            <Label>Tr·∫°ng th√°i</Label>
            <Select onValueChange={(value) => setValue('status', value as 'draft' | 'published' | 'archived')}>
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="draft">Nh√°p</SelectItem>
                <SelectItem value="published">Xu·∫•t b·∫£n</SelectItem>
                <SelectItem value="archived">L∆∞u tr·ªØ</SelectItem>
              </SelectContent>
            </Select>
          </div>

          {/* Submit Buttons */}
          <DialogFooter>
            <Button type="button" variant="outline" onClick={() => onOpenChange(false)}>
              H·ªßy
            </Button>
            <Button type="submit" disabled={isSubmitting}>
              {isSubmitting ? 'ƒêang l∆∞u...' : isEdit ? 'C·∫≠p nh·∫≠t' : 'T·∫°o m·ªõi'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

**Features**:
- ‚úÖ Auto-reset form khi m·ªü/ƒë√≥ng dialog
- ‚úÖ Preview ·∫£nh sau khi upload
- ‚úÖ Loading states (isSubmitting, isUploading)
- ‚úÖ Validation errors hi·ªÉn th·ªã realtime
- ‚úÖ Reusable cho c·∫£ Create v√† Edit

---

## 5. Public UI Components

### 5.1. PostCard Component

**File**: `components/posts/PostCard.tsx`

```tsx
import Image from 'next/image'
import Link from 'next/link'
import { formatDate } from '@/lib/utils'
import type { Post, Category } from '@prisma/client'

type PostWithCategory = Post & {
  category: Pick<Category, 'id' | 'name'> | null
}

interface PostCardProps {
  post: PostWithCategory
}

export function PostCard({ post }: PostCardProps) {
  return (
    <Link href={`/tin-tuc/${post.slug}`} className="group">
      <div className="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
        {/* Cover Image */}
        {post.cover_image && (
          <div className="relative h-48 w-full">
            <Image
              src={post.cover_image}
              alt={post.title}
              fill
              className="object-cover group-hover:scale-105 transition-transform duration-300"
            />
          </div>
        )}

        <div className="p-4">
          {/* Category Badge */}
          {post.category && (
            <span className="text-xs text-blue-600 font-semibold">
              {post.category.name}
            </span>
          )}

          {/* Title */}
          <h3 className="text-lg font-bold text-gray-900 mt-2 group-hover:text-blue-600 transition-colors">
            {post.title}
          </h3>

          {/* Excerpt */}
          {post.excerpt && (
            <p className="text-gray-600 text-sm mt-2 line-clamp-2">
              {post.excerpt}
            </p>
          )}

          {/* Meta */}
          <div className="flex items-center justify-between mt-4 text-xs text-gray-500">
            <span>{formatDate(post.created_at)}</span>
            <span>{post.views} l∆∞·ª£t xem</span>
          </div>
        </div>
      </div>
    </Link>
  )
}
```

**Features**:
- ‚úÖ Responsive card layout
- ‚úÖ Hover effects (shadow, scale, color)
- ‚úÖ Image optimization v·ªõi Next.js Image
- ‚úÖ Line clamp cho excerpt
- ‚úÖ Metadata (date, views)

### 5.2. Posts List Page

**File**: `app/tin-tuc/page.tsx`

```tsx
import { db } from '@/lib/db'
import { PostCard } from '@/components/posts/PostCard'

interface PageProps {
  searchParams: Promise<{ page?: string }>
}

export default async function PostsPage({ searchParams }: PageProps) {
  const params = await searchParams
  const page = parseInt(params.page || '1')
  const limit = 12
  const offset = (page - 1) * limit

  const [posts, total] = await Promise.all([
    db.post.findMany({
      where: { status: 'published' },  // Ch·ªâ hi·ªÉn th·ªã published
      include: {
        category: {
          select: { id: true, name: true }
        }
      },
      orderBy: { published_at: 'desc' },
      skip: offset,
      take: limit
    }),
    db.post.count({ where: { status: 'published' } })
  ])

  const totalPages = Math.ceil(total / limit)

  return (
    <div className="container mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold mb-8">Tin t·ª©c</h1>

      {/* Grid Layout */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {posts.map((post) => (
          <PostCard key={post.id} post={post} />
        ))}
      </div>

      {/* Pagination */}
      {totalPages > 1 && (
        <div className="flex justify-center gap-2 mt-8">
          {Array.from({ length: totalPages }, (_, i) => i + 1).map((p) => (
            <Link key={p} href={`/tin-tuc?page=${p}`}>
              <Button variant={p === page ? 'default' : 'outline'}>
                {p}
              </Button>
            </Link>
          ))}
        </div>
      )}
    </div>
  )
}
```

**Features**:
- ‚úÖ Server Component (no client-side JS needed)
- ‚úÖ Filter ch·ªâ posts c√≥ status = 'published'
- ‚úÖ Responsive grid (1/2/3 columns)
- ‚úÖ Pagination support

### 5.3. Post Detail Page

**File**: `app/tin-tuc/[slug]/page.tsx`

```tsx
import { notFound } from 'next/navigation'
import Image from 'next/image'
import { db } from '@/lib/db'
import { formatDate } from '@/lib/utils'

interface PageProps {
  params: Promise<{ slug: string }>
}

export default async function PostDetailPage({ params }: PageProps) {
  const { slug } = await params

  const post = await db.post.findUnique({
    where: { slug },
    include: {
      author: {
        select: { full_name: true, username: true }
      },
      category: {
        select: { id: true, name: true }
      }
    }
  })

  if (!post || post.status !== 'published') {
    notFound()
  }

  // Increment views (kh√¥ng await ƒë·ªÉ kh√¥ng block render)
  db.post.update({
    where: { id: post.id },
    data: { views: { increment: 1 } }
  }).catch(console.error)

  return (
    <article className="container mx-auto px-4 py-8 max-w-4xl">
      {/* Category */}
      {post.category && (
        <span className="text-sm text-blue-600 font-semibold">
          {post.category.name}
        </span>
      )}

      {/* Title */}
      <h1 className="text-4xl font-bold text-gray-900 mt-2">
        {post.title}
      </h1>

      {/* Meta */}
      <div className="flex items-center gap-4 text-sm text-gray-500 mt-4">
        <span>B·ªüi {post.author.full_name}</span>
        <span>‚Ä¢</span>
        <span>{formatDate(post.published_at || post.created_at)}</span>
        <span>‚Ä¢</span>
        <span>{post.views} l∆∞·ª£t xem</span>
      </div>

      {/* Cover Image */}
      {post.cover_image && (
        <div className="relative w-full h-96 mt-8">
          <Image
            src={post.cover_image}
            alt={post.title}
            fill
            className="object-cover rounded-lg"
            priority
          />
        </div>
      )}

      {/* Content */}
      <div 
        className="prose prose-lg max-w-none mt-8"
        dangerouslySetInnerHTML={{ __html: post.content }}
      />
    </article>
  )
}
```

**Features**:
- ‚úÖ SEO-friendly slug-based routing
- ‚úÖ Auto-increment views
- ‚úÖ 404 n·∫øu kh√¥ng published
- ‚úÖ Typography v·ªõi Tailwind Prose
- ‚úÖ Priority loading cho cover image

---

## 6. Form Validation

### 6.1. Zod Schema

**File**: `lib/validations.ts`

```typescript
import { z } from "zod"

export const postSchema = z.object({
  title: z.string().min(1, "Ti√™u ƒë·ªÅ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng").max(255),
  content: z.string().min(1, "N·ªôi dung kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng"),
  excerpt: z.string().max(500).optional(),
  cover_image: z.string().optional().or(z.literal("")),
  category_id: z.number().int().positive().optional().nullable(),
  status: z.enum(["draft", "published", "archived"]).default("draft"),
})

export type PostFormData = z.infer<typeof postSchema>
```

**Validation Rules**:
- `title`: Required, max 255 chars
- `content`: Required, unlimited length
- `excerpt`: Optional, max 500 chars
- `cover_image`: Optional string ho·∫∑c empty string
- `category_id`: Optional positive integer ho·∫∑c null
- `status`: Enum v·ªõi 3 values

### 6.2. Client-side Validation

**React Hook Form + Zod Resolver**:

```tsx
const { register, handleSubmit, formState: { errors } } = useForm<PostFormData>({
  resolver: zodResolver(postSchema),
  defaultValues: {
    title: '',
    content: '',
    status: 'draft',
  }
})
```

**Error Display**:

```tsx
<Input {...register('title')} />
{errors.title && (
  <p className="text-sm text-red-500">{errors.title.message}</p>
)}
```

### 6.3. Server-side Validation

**API Route**:

```typescript
try {
  const validatedData = postSchema.parse(body)
  // ‚úÖ Data ƒë√£ ƒë∆∞·ª£c validate
} catch (error) {
  if (error instanceof z.ZodError) {
    return NextResponse.json(
      { success: false, errors: error.errors },
      { status: 400 }
    )
  }
}
```

---

## 7. File Upload

### 7.1. Upload API

**File**: `app/api/upload/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { writeFile, mkdir } from 'fs/promises'
import path from 'path'

export async function POST(request: NextRequest) {
  try {
    const formData = await request.formData()
    const file = formData.get('file') as File
    const type = formData.get('type') as string // 'posts', 'projects', etc.

    if (!file) {
      return NextResponse.json(
        { success: false, message: 'No file uploaded' },
        { status: 400 }
      )
    }

    // Validate file type
    if (!file.type.startsWith('image/')) {
      return NextResponse.json(
        { success: false, message: 'Only images allowed' },
        { status: 400 }
      )
    }

    // Create unique filename
    const bytes = await file.arrayBuffer()
    const buffer = Buffer.from(bytes)
    const filename = `${Date.now()}-${file.name.replace(/\s/g, '-')}`
    const uploadDir = path.join(process.cwd(), 'public', 'uploads', type)
    const filepath = path.join(uploadDir, filename)

    // Ensure directory exists
    await mkdir(uploadDir, { recursive: true })

    // Save file
    await writeFile(filepath, buffer)

    const url = `/uploads/${type}/${filename}`

    return NextResponse.json({
      success: true,
      data: { url, filename }
    })
  } catch (error) {
    console.error('Upload error:', error)
    return NextResponse.json(
      { success: false, message: 'Upload failed' },
      { status: 500 }
    )
  }
}
```

### 7.2. Client Upload Handler

```tsx
const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0]
  if (!file) return

  setIsUploading(true)
  try {
    const formData = new FormData()
    formData.append('file', file)
    formData.append('type', 'posts')

    const response = await fetch('/api/upload', {
      method: 'POST',
      body: formData,  // Kh√¥ng set Content-Type header (FormData t·ª± ƒë·ªông)
    })

    if (!response.ok) throw new Error('Upload failed')

    const result = await response.json()
    setValue('cover_image', result.data.url)  // Set v√†o form
    setPreviewImage(result.data.url)          // Preview
    
    toast({
      title: 'Th√†nh c√¥ng',
      description: 'ƒê√£ upload ·∫£nh',
    })
  } catch (error) {
    toast({
      title: 'L·ªói',
      description: 'Upload th·∫•t b·∫°i',
      variant: 'destructive',
    })
  } finally {
    setIsUploading(false)
  }
}
```

**File Storage Structure**:
```
public/
  uploads/
    posts/
      1702345678-bai-viet-1.jpg
      1702345679-bai-viet-2.png
    projects/
      ...
```

---

## 8. Complete Workflow

### 8.1. Create Post Flow

```
1. User clicks "T·∫°o b√†i vi·∫øt m·ªõi"
   ‚îî‚îÄ> PostsTable component
   ‚îî‚îÄ> setIsCreateOpen(true)

2. Dialog opens
   ‚îî‚îÄ> PostFormDialog component
   ‚îî‚îÄ> Form reset v·ªõi defaultValues

3. User fills form
   ‚îî‚îÄ> React Hook Form qu·∫£n l√Ω state
   ‚îî‚îÄ> Zod validation realtime

4. User uploads cover image (optional)
   ‚îî‚îÄ> handleFileUpload()
   ‚îî‚îÄ> POST /api/upload
   ‚îî‚îÄ> Server l∆∞u file v√†o public/uploads/posts/
   ‚îî‚îÄ> Return URL
   ‚îî‚îÄ> setValue('cover_image', url)
   ‚îî‚îÄ> Preview image

5. User submits form
   ‚îî‚îÄ> handleSubmit(onSubmit)
   ‚îî‚îÄ> Zod validation
   ‚îî‚îÄ> POST /api/posts
   ‚îî‚îÄ> Server:
       ‚îú‚îÄ> Check authentication
       ‚îú‚îÄ> Validate data
       ‚îú‚îÄ> Generate slug t·ª´ title
       ‚îú‚îÄ> Create post trong database
       ‚îî‚îÄ> Return success

6. Success callback
   ‚îî‚îÄ> Toast notification
   ‚îî‚îÄ> window.location.reload()
   ‚îî‚îÄ> Dialog closes
```

### 8.2. Edit Post Flow

```
1. User clicks "Ch·ªânh s·ª≠a" trong dropdown
   ‚îî‚îÄ> setEditingPost(post)

2. Dialog opens v·ªõi post data
   ‚îî‚îÄ> PostFormDialog receives post prop
   ‚îî‚îÄ> useEffect resets form v·ªõi post values
   ‚îî‚îÄ> Preview image n·∫øu c√≥ cover_image

3. User modifies form
   ‚îî‚îÄ> React Hook Form tracking changes

4. User uploads new image (optional)
   ‚îî‚îÄ> handleFileUpload()
   ‚îî‚îÄ> Old image URL ƒë∆∞·ª£c replace

5. User submits
   ‚îî‚îÄ> PUT /api/posts/[id]
   ‚îî‚îÄ> Server:
       ‚îú‚îÄ> Check authentication
       ‚îú‚îÄ> Find existing post
       ‚îú‚îÄ> Validate new data
       ‚îú‚îÄ> Update post
       ‚îú‚îÄ> Smart published_at logic
       ‚îî‚îÄ> Return success

6. Success
   ‚îî‚îÄ> Reload page
   ‚îî‚îÄ> See updated data
```

### 8.3. Delete Post Flow

```
1. User clicks "X√≥a"
   ‚îî‚îÄ> setDeletingPost(post)

2. Confirmation dialog opens
   ‚îî‚îÄ> AlertDialog shows post title

3. User confirms
   ‚îî‚îÄ> handleDelete()
   ‚îî‚îÄ> setIsDeleting(true)
   ‚îî‚îÄ> DELETE /api/posts/[id]
   ‚îî‚îÄ> Server deletes post

4. Success
   ‚îî‚îÄ> Toast notification
   ‚îî‚îÄ> window.location.reload()
   ‚îî‚îÄ> Post disappears from list
```

### 8.4. View Post Flow (Public)

```
1. User visits /tin-tuc
   ‚îî‚îÄ> Server Component renders
   ‚îî‚îÄ> Fetch posts v·ªõi status = 'published'
   ‚îî‚îÄ> Grid layout v·ªõi PostCard

2. User clicks post card
   ‚îî‚îÄ> Navigate to /tin-tuc/[slug]
   ‚îî‚îÄ> Server Component:
       ‚îú‚îÄ> findUnique({ where: { slug } })
       ‚îú‚îÄ> Check status = 'published'
       ‚îú‚îÄ> Increment views (async, kh√¥ng block)
       ‚îî‚îÄ> Render HTML

3. Page displays
   ‚îî‚îÄ> SEO-optimized
   ‚îî‚îÄ> Fast load v·ªõi Server Component
   ‚îî‚îÄ> No client-side JavaScript needed
```

---

## üéØ T·ªïng K·∫øt

### ‚úÖ ƒê√£ h·ªçc ƒë∆∞·ª£c:

1. **Database Design**: Post model v·ªõi relationships
2. **API Routes**: CRUD operations ho√†n ch·ªânh
3. **Authentication**: Protected routes
4. **Validation**: Client + Server v·ªõi Zod
5. **File Upload**: Image upload v√† storage
6. **UI Components**: Admin table, form dialog, public cards
7. **State Management**: React Hook Form + useState
8. **Server Components**: Fast public pages
9. **Slug Generation**: SEO-friendly URLs
10. **View Tracking**: Auto-increment views

### üìù Best Practices:

- ‚úÖ Always validate c·∫£ client v√† server
- ‚úÖ Use Server Components khi c√≥ th·ªÉ
- ‚úÖ Implement loading states
- ‚úÖ Handle errors gracefully
- ‚úÖ Use toast notifications
- ‚úÖ Confirm before delete
- ‚úÖ Generate slugs automatically
- ‚úÖ Preview images before upload
- ‚úÖ Reset forms after success

### üöÄ Next Steps:

- ƒê·ªçc **08.2_FEATURES_PROJECTS.md** ƒë·ªÉ h·ªçc Projects management
- Implement search functionality
- Add rich text editor (TinyMCE, Quill)
- Add image resize/crop
- Implement soft delete
- Add draft auto-save

---

**Ch√∫c m·ª´ng!** üéâ B·∫°n ƒë√£ hi·ªÉu 100% Posts Management system!

*Last updated: November 28, 2025*
